<html>
  <head>
    <title>openFDA query explorer</title>
    <script src="js/jquery-1.11.0.min.js" charset="utf-8"></script>
    <script src="js/d3.min.js" charset="utf-8"></script>
    <script src="js/c3.min.js" charset="utf-8"></script>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/c3.css">
    <link rel="stylesheet" type="text/css" href="openfda-query-explorer.css">
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <section class="api-query col-md-12">
          <div class="row">
            <div class="col-md-12">
              <h3>openFDA query explorer prototype</h3>
              <div>
                <pre id="query-endpoint">https://api.fda.gov/drug/event.json?</pre>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-1"><label for="query-search control-label"><pre>search=</pre></label></div>
            <div class="col-md-5"><textarea id="query-search" class="query-textarea form-control">openfda.unii_indexing.va.name:"nonsteroidal+anti-inflammatory+drug"</textarea></div>
            <div class="col-md-1"><label for="query-count control-label"><pre>count=</pre></label></div>
            <div class="col-md-5"><textarea id="query-count" class="query-textarea form-control">patient.reaction.reactionmeddrapt.exact</textarea></div>
          </div>
          
          <div class="row">
            <div class="form-group">
              <div class="col-md-2 col-md-offset-10">
                <button id="query-button" class="form-control btn btn-primary">Run query</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="row">
        <section class="col-md-12">
          <section class="col-md-2 api-query-control">
            <div class="row">
              <h4>Search ideas</h4>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-search" id="company-either" value="">
                  <strong>All adverse event reports</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-search" id="company-yes" value="_exists_:companynumb">
                  <strong>Reported by manufacturers</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-search" id="company-no" value="_missing_:companynumb">
                  <strong>Reported directly by public</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-search" id="reaction-nausea" value="patient.reaction.reactionmeddrapt:nausea">
                  <strong>Reactions included <em>nausea</em></strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-search" id="reaction-nausea" value="patient.drug.drugindication:hypertension">
                  <strong>Indications included <em>hypertension</em></strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-search" id="reaction-nausea" value="patient.drug.drugindication:sclerosis+AND+serious:2">
                  <strong>Indications included <em>sclerosis</em> and <em>not serious</em></strong>
                </label>
              </div>
            </div>
            
            <div class="row">
              <h4 style="margin-top: 15px;">Count options</h4>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-count" id="count-country" value="patient.reaction.reactionmeddrapt.exact" checked>
                  <strong>Patient reaction</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-count" id="count-country" value="primarysource.reportercountry.exact">
                  <strong>Reporter country</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-count" id="count-qualification" value="primarysource.qualification">
                  <strong>Report originator</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-count" id="count-serious" value="serious">
                  <strong>Serious</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-count" id="count-sex" value="patient.patientsex">
                  <strong>Patient sex</strong>
                </label>
              </div>
              <div class="radio">
                <label>
                  <input type="radio" name="api-query-options-count" id="count-indication" value="patient.drug.drugindication.exact">
                  <strong>Indications for use</strong>
                </label>
              </div>
            </div>
          </section>
          
          <section class="chart col-md-2">
            <h3 style="color: #bababa">Coverage</h3>
            <div id="chart-coverage"></div>
          </section>
          <section class="chart col-md-8">
            <h3 id="result-count"></h3>
            <div id="chart"></div>
          </section>
        </section>
      </div>
      <div class="row">
        <section id="result" class="col-md-3"></section>
      </div>
    </div>
    
    <script type="text/javascript">
      var resultMax, resultTotal;

      function displayData(data) {
        data = data.slice(1,21);

        $.each(data, function(key, val) {
          var dl = $('<dl></dl>');
          $.each(val, function(k, v) {
            $('<dd>' + v + '</dd>').appendTo(dl);
          });
          dl.appendTo('#result');
        });
      };

      function toTitleCase(string) {
        return string.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
      }

      function determineChartContent(data) {
        var queryCount = $(".api-query").find("#query-count").val(),
            chartContent = "";
        
        if (queryCount.toLowerCase().indexOf("primarysource.reportercountry") >= 0) {
          chartContent = "primarysource.reportercountry";
          return chartContent;
        }
        else if (queryCount.toLowerCase().indexOf("primarysource.qualification") >= 0) {
          chartContent = "primarysource.qualification";
          return chartContent;
        }
        else if (queryCount.toLowerCase().indexOf("serious") >= 0) {
          chartContent = "serious";
          return chartContent;
        }
        else if (queryCount.toLowerCase().indexOf("patient.patientsex") >= 0) {
          chartContent = "patient.patientsex";
          return chartContent;
        }
        else if (queryCount != "" && data.length >= 1) {
          chartContent = "count";
          return chartContent;
        }
      };

      function getResultTotal(data) {
        return data[0].results.total;
      };

      function updateCoverageChart(resultMax, resultTotal) {
        resultMax -= resultTotal;

        var chart = c3.generate({
          bindto: '#chart-coverage',
          data: {
            columns: [
              ['Non-matching reports', resultMax],
              ['Matching reports', resultTotal]
            ],
            type: 'bar',
            groups: [
              ['Non-matching reports', 'Matching reports']
            ]
          },
          color: {
            pattern: ['#bbb', '#0053ab']
          },
          width: 50,
          height: 100,
          margin: 0,
          legend: {
            show: false
          },
          axis: {
            x: {
              show: false
            },
            y: {
              show: false
            }
          },
          bar: {
            width: {
              ratio: .5
            }
          }
        });
      };

      function updateResultCount(data) {
        $("#result-count").text(data + " matching adverse event reports");
      };

      function drawChartWithData(data) {
        var dataForChart = [],
            chartContent = determineChartContent(data),
            chart = c3.generate({
              data: {
                columns: [],
                type : 'donut'
              },
              color: {
                pattern: ['#8551a3', '#323aa5', '#7f8091', '#4689aa', '#45ac7e', '#5e991f', '#a6b11f', '#b37748', '#b65388', '#b85d07']
              },
              bar: {
                width: {
                  ratio: 1.0
                }
              }
            });

        // 1. Slice data to appropriate length.
        // 2. Iterate through values.
        // 3. Apply processing logic (chart data-dependent).

        function iterateThroughValues(data, processingLogic) {
          $.each(data, function(key, val) {
            var dataPair = [];
            $.each(val, function (k, v) {
              dataPair.push(processingLogic(k, v));
            });
            dataForChart.push(dataPair);
          });
        };

        if (chartContent == "count") {
          data = data.slice(1, 11);
          var processingLogic = function(k, v) {
            k == "term" && (v = v.toLowerCase());
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            type: "bar",
            title: "Generic count"
          });
          // chart.toBar();
        }
        else if (chartContent == "primarysource.qualification") {
          data = data.slice(1, 6);
          var processingLogic = function(k, v) {
            if (k == "term") {
              if      (v == "1") { v = "Physician" }
              else if (v == "2") { v = "Pharmacist" }
              else if (v == "3") { v = "Other health professional" }
              else if (v == "4") { v = "Lawyer" }
              else if (v == "5") { v = "Consumer or non-health professional" }
            }
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            type: "donut",
            title: "Report originator"
          });
          // chart.toDonut();
        }
        else if (chartContent == "primarysource.reportercountry") {
          data = data.slice(1,11);
          var processingLogic = function(k, v) {
            k == "term" && (v = toTitleCase(v));
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            type: "bar",
            title: "Reporter country"
          });
          // chart.toBar();
        }
        else if (chartContent == "serious") {
          data = data.slice(1, 3);
          var processingLogic = function(k, v) {
            if (k == "term") {
              if      (v == "1") { v = "Death, life threatening condition, hospitalization, disability, congenital anomali, or other serious condition" }
              else if (v == "2") { v = "Other" }
            }
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            type: "donut",
            title: "Seriousness"
          });
          // chart.toDonut();
        }
        else if (chartContent == "patient.patientsex") {
          data = data.slice(1, 4);
          var processingLogic = function(k, v) {
            if (k == "term") {
              if      (v == "1") { v = "Male" }
              else if (v == "2") { v = "Female" }
              else if (v == "0") { v = "Other" }
            }
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            type: "donut",
            title: "Patient sex"
          });
          // chart.toDonut();
        }
        else {
          console.log("Not countable")
        }
      };

      function runQuery(queryStringForMax, queryStringForTotal, queryString) {
        var queryStringForMax = queryStringForMax,
            queryStringForTotal = queryStringForTotal;

        // Run API query and draw chart with data.
        //
        $.getJSON(queryString, function(data) {
          drawChartWithData(data);
        });

        // Update total number of matching results.
        //
        $.getJSON(queryStringForTotal, function(data) {
          updateResultCount(getResultTotal(data));
        });

        // Update coverage chart.
        //
        var resultMax, resultTotal;
        $.when(
          $.getJSON(queryStringForMax, function(data) {
            resultMax = getResultTotal(data);
          }),
          $.getJSON(queryStringForTotal, function(data) {
            resultTotal = getResultTotal(data);
          })
        ).then(function() {
          updateCoverageChart(resultMax, resultTotal);
        });
      };

      $(document).ready(function() {
        function executeQuery() {
          var queryString = "https://api.fda.gov/drug/event.json?",
              // queryString = $(".api-query").find("#query-endpoint").text(),
              querySearch = $(".api-query").find("#query-search").val(),
              queryCount  = $(".api-query").find("#query-count").val();

          // Temporary logic to run a separate query to get an accurate record count.
          // Necessary because when queries have &count= the API returns an inaccurate
          // total in the openfda metadata section.
          // 
          var queryStringForMax = (queryString + "search=_exists_:receivedate&limit=1");
          var queryStringForTotal = queryString;
          querySearch != "" && (queryStringForTotal += "search=" + querySearch);
          querySearch == "" && (queryStringForTotal += "search=_exists_:receivedate&limit=1");
          
          // Construct the full queryString.
          //
          querySearch != "" && (queryString += "search=" + querySearch);
          queryCount  != "" && (queryString += "&count=" + queryCount);

          runQuery(queryStringForMax, queryStringForTotal, queryString);
          $(".api-query").find("#query-endpoint").text(queryString);
        };
        
        // Execute query on initial page load.
        //
        executeQuery();
        
        // Handle keypresses.
        //
        $(".query-textarea").keypress(function(e) {
          var code = (e.keyCode ? e.keyCode : e.which),
              button = $(this).parents(".api-query").find("button#query-button");
          
          if      (code == 32) { e.preventDefault(); } // Space
          else if (code == 13) {                       // Return
            e.preventDefault();
            $(button).trigger('click');
          };
        });

        // Change SEARCH= parameter based on radio value.
        //
        $("input[name=api-query-options-search]:radio").change(function() {
          var queryTextArea = $(".api-query").find("#query-search"),
              queryStringFromRadioButton = $(this).val();
          queryTextArea.val(queryStringFromRadioButton);
          $("button#query-button").trigger("click");
        });

        // Change COUNT= parameter based on radio value.
        //
        $("input[name=api-query-options-count]:radio").change(function() {
          var queryTextArea = $(".api-query").find("#query-count"),
              queryStringFromRadioButton = $(this).val();
          queryTextArea.val(queryStringFromRadioButton);
          $("button#query-button").trigger("click");
        });

        $("button#query-button").click(function () {
          executeQuery();
        });
      });
    </script>
  </body>
</html>