<html>
  <head>
    <title>openFDA query explorer</title>
    <script src="js/jquery-1.11.0.min.js" charset="utf-8"></script>
    <script src="js/d3.min.js" charset="utf-8"></script>
    <script src="js/c3.min.js" charset="utf-8"></script>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/c3.css">
    <link rel="stylesheet" type="text/css" href="openfda-query-explorer.css">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <section class="api-query col-md-12">
          <div class="row">
            <div class="form-group col-md-12">
              <div>
                <pre id="query-endpoint">https://api.fda.gov/drug/event.json?</pre>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="form-group col-md-6">
              <label for="query-search control-label"><pre>search=</pre></label>
              <textarea id="query-search" class="query-textarea form-control"></textarea>
            </div>
            <div class="form-group col-md-6">
              <label for="query-count control-label col-sm-3"><pre>count=</pre></label>
              <textarea id="query-count" class="query-textarea form-control">primarysource.qualification</textarea>
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <div class="col-md-2 col-md-offset-10">
                <button id="query-button" class="form-control btn btn-primary">Run query</button>
              </div>
            </div>
          </div>
        </section>
      </div>
      <div class="row">
        <section class="col-md-3 api-query-control">
          <!-- <div class="radio">
            <label>
              <input type="radio" name="api-query-options-search" id="company-either" value="" checked>
              <strong>All adverse event reports</strong>
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="api-query-options-search" id="company-yes" value="_exists_:companynumb">
              <strong>Reports routed through manufacturers</strong><br />
              <span style="color: #999">A manufacturer number in the field `companynumb`</span>
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="api-query-options-search" id="company-no" value="_missing_:companynumb">
              <strong>Reports directly from consumers</strong><br />
              <span style="color: #999">Empty field `companynumb`</span>
            </label>
          </div> -->
          <div class="radio">
            <label>
              <input type="radio" name="api-query-options-count" id="count-country" value="patient.reaction.reactionmeddrapt.exact">
              <strong>Patient reaction</strong>
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="api-query-options-count" id="count-country" value="primarysource.reportercountry.exact">
              <strong>Reporter country</strong>
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="api-query-options-count" id="count-qualification" value="primarysource.qualification">
              <strong>Report originator</strong>
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="api-query-options-count" id="count-serious" value="serious">
              <strong>Serious</strong>
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="api-query-options-count" id="count-sex" value="patient.patientsex">
              <strong>Patient sex</strong>
            </label>
          </div>
        </section>
        <section class="chart col-md-8 col-md-offset-1">
          <div id="chart">
          </div>
        </section>
      </div>
      <div class="row">
        <section id="result" class="col-md-3"></section>
      </div>
    </div>
    
    <script type="text/javascript">
      function displayData(data) {
        data = data.slice(1,21);

        $.each(data, function(key, val) {
          var dl = $('<dl></dl>');
          $.each(val, function(k, v) {
            $('<dd>' + v + '</dd>').appendTo(dl);
          });
          dl.appendTo('#result');
        });
      };

      function getTotalsFromData(data) {
        data = data.slice(0,1);
        $.each(data, function(key, val) {
          $.each(val, function(k, v) {
          // console.log(v);
          // appendTo($("#result"));
          });
        });
      };

      function toTitleCase(string) {
        return string.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
      }

      function determineChartContent(data) {
        var queryCount = $(".api-query").find("#query-count").val(),
            chartContent = "";
        
        if (queryCount.toLowerCase().indexOf("primarysource.reportercountry") >= 0) {
          chartContent = "primarysource.reportercountry";
          return chartContent;
        }
        else if (queryCount.toLowerCase().indexOf("primarysource.qualification") >= 0) {
          chartContent = "primarysource.qualification";
          return chartContent;
        }
        else if (queryCount.toLowerCase().indexOf("serious") >= 0) {
          chartContent = "serious";
          return chartContent;
        }
        else if (queryCount.toLowerCase().indexOf("patient.patientsex") >= 0) {
          chartContent = "patient.patientsex";
          return chartContent;
        }
        else if (queryCount != "" && data.length >= 1) {
          chartContent = "count";
          return chartContent;
        }
        // console.log(chartContent);
      };

      // Standalone chart var.
      // var chart = c3.generate({
      //   data: {
      //     columns: [],
      //     // type : 'donut'
      //   },
      //   color: {
      //     pattern:['#9541a3', '#623ca5', '#3643a8', '#307aaa', '#29aca1', '#23af5e', '#25b11c', '#6bb316', '#b6b10f', '#b85d07']
      //   },
      //   bar: {
      //     width: {
      //       ratio: 1.0 // this makes bar width 50% of length between ticks
      //     }
      //   }
      // });

      function drawChartWithData(data) {
        var dataForChart = [],
            chartContent = determineChartContent(data)
            // ;
            ,
            chart = c3.generate({
              data: {
                columns: [],
                type : 'donut'
              },
              color: {
                pattern:['#9541a3', '#623ca5', '#3643a8', '#307aaa', '#29aca1', '#23af5e', '#25b11c', '#6bb316', '#b6b10f', '#b85d07']
              },
              bar: {
                width: {
                  ratio: 1.0 // this makes bar width 50% of length between ticks
                }
              }
            });

        // 1. Slice data to appropriate length.
        // 2. Iterate through values.
        // 3. Apply processing logic (chart data-dependent).

        function iterateThroughValues(data, processingLogic) {
          $.each(data, function(key, val) {
            var dataPair = [];
            $.each(val, function (k, v) {
              dataPair.push(processingLogic(k, v));
            });
            dataForChart.push(dataPair);
          });
        };

        if (chartContent == "count") {
          data = data.slice(1, 11);
          var processingLogic = function(k, v) {
            k == "term" && (v = v.toLowerCase());
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            // type: "bar",
            title: "Generic count"
          });
          chart.toBar();
        }
        else if (chartContent == "primarysource.qualification") {
          data = data.slice(1, 6);
          var processingLogic = function(k, v) {
            if (k == "term") {
              if      (v == "1") { v = "Physician" }
              else if (v == "2") { v = "Pharmacist" }
              else if (v == "3") { v = "Other health professional" }
              else if (v == "4") { v = "Lawyer" }
              else if (v == "5") { v = "Consumer or non-health professional" }
              // else if (v == "UNITED STATES") { v = "Pharmacist" }
              // else if (v == "JAPAN") { v = "Physician" }
              // else if (v == "UNITED KINGDOM") { v = "Lawyer" }
              // else if (v == "FRANCE") { v = "Consumer or non-health professional" }
              // else if (v == "GERMANY") { v = "Other health professional" }
            }
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            // type: "donut",
            title: "Report originator"
          });
          chart.toDonut();
        }
        else if (chartContent == "primarysource.reportercountry") {
          data = data.slice(1,11);
          var processingLogic = function(k, v) {
            k == "term" && (v = toTitleCase(v));
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            // type: "bar",
            title: "Reporter country"
          });
          chart.toBar();
        }
        else if (chartContent == "serious") {
          data = data.slice(1, 3);
          var processingLogic = function(k, v) {
            if (k == "term") {
              if      (v == "1") { v = "Death, life threatening condition, hospitalization, disability, congenital anomali, or other serious condition" }
              else if (v == "2") { v = "Other" }
            }
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            // type: "donut",
            title: "Seriousness"
          });
          chart.toDonut();
        }
        else if (chartContent == "patient.patientsex") {
          data = data.slice(1, 4);
          var processingLogic = function(k, v) {
            if (k == "term") {
              if      (v == "1") { v = "Male" }
              else if (v == "2") { v = "Female" }
              else if (v == "0") { v = "Other" }
            }
            return v;
          };
          iterateThroughValues(data, processingLogic);
          chart.load({
            columns: dataForChart,
            // type: "donut",
            title: "Patient sex"
          });
          chart.toDonut();
        }
        else {
          console.log("Not countable")
        }

        // Original data processing
        //
        // if (chartContent == "primarysource.qualification") {
        //   chartType = "donut";
        //   data = data.slice(1,6);
        //   $.each(data, function(key, val) {
        //     var dataPair = [];
        //     $.each(val, function (k, v) {
        //       if (k == "term") {
        //         if      (v == "1") { v = "Physician" }
        //         else if (v == "2") { v = "Pharmacist" }
        //         else if (v == "3") { v = "Other health professional" }
        //         else if (v == "4") { v = "Lawyer" }
        //         else if (v == "5") { v = "Consumer or non-health professional" }
        //         dataPair.push(v);
        //       }
        //       else if (k == "count") {
        //         dataPair.push(v);
        //       }
        //     });
        //     dataForChart.push(dataPair);
        //   });
        //   chart.load({
        //     columns: dataForChart,
        //     type: "donut",
        //     title: "Report originator"
        //   });
        // }
        // else if (chartContent == "primarysource.reportercountry") {
        //   data = data.slice(1,11);
        //   $.each(data, function(key, val) {
        //     var dataPair = [];
        //     $.each(val, function (k, v) {
        //       if (k == "term") {
        //         dataPair.push(v);
        //       }
        //       else if (k == "count") {
        //         dataPair.push(v);
        //       }
        //     });
        //     dataForChart.push(dataPair);
        //   });
        //   chart.load({
        //     columns: dataForChart,
        //     type: "bar",
        //     title: "Reporter country",
        //     axis: {
        //       y: {
        //         tick: {
        //           culling: {
        //             max: 150
        //           }
        //         }
        //       }
        //     }
        //   });
        // }
        // else {
        //   console.log("Not primarysource")
        // }

        // var chart = c3.generate({
        //   data: {
        //     columns: dataForChart,
        //     type : 'donut',
        //   },
        //   color: {
        //     pattern:['#9541a3', '#623ca5', '#3643a8', '#307aaa', '#29aca1', '#23af5e', '#25b11c', '#6bb316', '#b6b10f', '#b85d07']
        //   },
        //   donut: {
        //     title: "Report originator",
        //     onclick: function (d, i) { console.log(d, i); },
        //     onmouseover: function (d, i) { console.log(d, i); },
        //     onmouseout: function (d, i) { console.log(d, i); }
        //   },
        //   bar: {
        //     width: {
        //       ratio: 0.5 // this makes bar width 50% of length between ticks
        //     }
        //   }
        // });

        console.log(dataForChart);
      };

      function runQuery(queryString) {
        // Mock data.
        // var data = [
        //    {
        //       openfda: {
        //          disclaimer: "openFDA is a beta research project and not for clinical use. While we make every effort to ensure that data is accurate, you should assume all results are unvalidated.",
        //          license: "The data within this API is Public Domain and released under Creative Commons CC0.",
        //          last_updated: "2014-05-01"
        //       },
        //       results: {
        //          total: 42396
        //       }
        //    },
        //    {
        //       term: "UNITED STATES",
        //       count: 2262128
        //    },
        //    {
        //       term: "JAPAN",
        //       count: 203893
        //    },
        //    {
        //       term: "UNITED KINGDOM",
        //       count: 158195
        //    },
        //    {
        //       term: "FRANCE",
        //       count: 127959
        //    },
        //    {
        //       term: "GERMANY",
        //       count: 117715
        //    },
        //    {
        //       term: "CANADA",
        //       count: 77891
        //    },
        //    {
        //       term: "BRAZIL",
        //       count: 48662
        //    },
        //    {
        //       term: "AUSTRALIA",
        //       count: 38949
        //    },
        //    {
        //       term: "ITALY",
        //       count: 35332
        //    },
        //    {
        //       term: "SPAIN",
        //       count: 28884
        //    },
        //    {
        //       term: "SWITZERLAND",
        //       count: 25234
        //    },
        //    {
        //       term: "NETHERLANDS",
        //       count: 22011
        //    },
        //    {
        //       term: "DENMARK",
        //       count: 16395
        //    },
        //    {
        //       term: "BELGIUM",
        //       count: 15857
        //    },
        //    {
        //       term: "SWEDEN",
        //       count: 14615
        //    },
        //    {
        //       term: "IRELAND",
        //       count: 12629
        //    },
        //    {
        //       term: "CHINA",
        //       count: 12425
        //    },
        //    {
        //       term: "KOREA, REPUBLIC OF",
        //       count: 9845
        //    },
        //    {
        //       term: "INDIA",
        //       count: 9577
        //    },
        //    {
        //       term: "TURKEY",
        //       count: 9478
        //    },
        //    {
        //       term: "MEXICO",
        //       count: 9268
        //    },
        //    {
        //       term: "GREECE",
        //       count: 8794
        //    },
        //    {
        //       term: "AUSTRIA",
        //       count: 8349
        //    },
        //    {
        //       term: "TAIWAN, PROVINCE OF CHINA",
        //       count: 8129
        //    },
        //    {
        //       term: "ARGENTINA",
        //       count: 7449
        //    },
        //    {
        //       term: "POLAND",
        //       count: 7448
        //    },
        //    {
        //       term: "NORWAY",
        //       count: 7405
        //    },
        //    {
        //       term: "SOUTH AFRICA",
        //       count: 6259
        //    },
        //    {
        //       term: "ISRAEL",
        //       count: 6223
        //    },
        //    {
        //       term: "FINLAND",
        //       count: 5629
        //    },
        //    {
        //       term: "PORTUGAL",
        //       count: 5509
        //    },
        //    {
        //       term: "COLOMBIA",
        //       count: 5389
        //    },
        //    {
        //       term: "VENEZUELA",
        //       count: 5166
        //    },
        //    {
        //       term: "NEW ZEALAND",
        //       count: 4480
        //    }
        // ]
        // getTotalsFromData(data);
        // drawChartWithData(data);

        // Use API.
        $.getJSON(queryString, function(data) {
          getTotalsFromData(data);
          drawChartWithData(data);
        });
      };

      $(document).ready(function() {
        $(".query-textarea").keypress(function(e) {
          var code = (e.keyCode ? e.keyCode : e.which),
              button = $(this).parents(".api-query").find("button#query-button");
          
          if      (code == 32) { e.preventDefault(); } // Space
          else if (code == 13) {                       // Return
            e.preventDefault();
            $(button).trigger('click');
          };
        });

        // Change SEARCH= parameter
        //
        $("input[name=api-query-options-search]:radio").change(function() {
          console.log($(this).val());
          var queryTextArea = $(".api-query").find("#query-search"),
              queryStringFromRadioButton = $(this).val();
          queryTextArea.val(queryStringFromRadioButton);
          $("button#query-button").trigger("click");
        });

        // Change COUNT= parameter
        //
        $("input[name=api-query-options-count]:radio").change(function() {
          // console.log($(this).val());
          var queryTextArea = $(".api-query").find("#query-count"),
              queryStringFromRadioButton = $(this).val();
          queryTextArea.val(queryStringFromRadioButton);
          $("button#query-button").trigger("click");
        });

        $("button#query-button").click(function () {
          var queryString = $(this).parents(".api-query").find("#query-endpoint").text(),
              querySearch = $(this).parents(".api-query").find("#query-search").val(),
              queryCount  = $(this).parents(".api-query").find("#query-count").val();

          queryString != "" && (queryString += "search=" + querySearch);
          queryCount  != "" && (queryString += "&count=" + queryCount);

          runQuery(queryString);
        });
      });
    </script>
  </body>
</html>
